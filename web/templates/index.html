<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
  <title>Service Status</title>
  <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg"/>
  <meta name="theme-color" content="#0c121c"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="stylesheet" href="/static/css/main.css"/>
  <link rel="stylesheet" href="/static/css/blocks.css"/>
  <!-- Load utils first, without defer -->
  <script src="/static/js/utils.js"></script>
  <!-- Then load other scripts with defer -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="/static/js/app.js" defer></script>
  <script src="/static/js/blocks.js" defer></script>
</head>
<body>
  <!-- Site Alerts Banner -->
  <div id="siteAlerts"></div>

  <header>
    <div class="brand">
      <h1>Service Status</h1>
      <small>Updated <span id="updated">‚Äî</span></small>
    </div>
    <div class="user">
      <span id="welcome" class="muted">Public view</span>
      <button id="loginBtn" class="ghost">Login</button>
      <button id="logoutBtn" class="ghost hidden">Logout</button>
    </div>
  </header>

  <main>
    <!-- Dynamic service cards will be rendered here by JavaScript -->
    <div id="services-container"></div>

    <section class="card">
      <div class="row"><div><strong>Recent incidents</strong><div class="label">Last 24h</div></div></div>
      <ul id="incidents"></ul>
    </section>
  </main>

  <!-- Full-width Resources Section - start hidden, JS shows based on config -->
  <section class="card resources-section hidden" id="card-resources">
    <div class="row">
      <div class="row-left">
        <div class="res-title">
          <strong>Resources</strong>
        </div>
      </div>
      <span class="pill warn" id="resources-pill">‚Äî</span>
    </div>

    <div class="resources-grid">
      <div class="resource-tile hidden" data-kind="cpu">
        <div class="tile-head">
          <div class="tile-label">üñ•Ô∏è CPU</div>
          <div class="tile-kpi" id="res-cpu">‚Äî</div>
        </div>
        <div class="meter" aria-hidden="true"><div class="meter-fill" id="meter-cpu"></div></div>
        <div class="tile-sub" id="res-cpu-detail">‚Äî</div>
      </div>

      <div class="resource-tile hidden" data-kind="mem">
        <div class="tile-head">
          <div class="tile-label">üíæ RAM</div>
          <div class="tile-kpi" id="res-mem">‚Äî</div>
        </div>
        <div class="meter" aria-hidden="true"><div class="meter-fill" id="meter-mem"></div></div>
        <div class="tile-sub" id="res-mem-detail">‚Äî</div>
      </div>

      <div class="resource-tile hidden" data-kind="temp">
        <div class="tile-head">
          <div class="tile-label">üå° System Temp</div>
          <div class="tile-kpi" id="res-temp">‚Äî</div>
        </div>
        <div class="temp-minmax" aria-hidden="true">
          <div class="temp-mm temp-mm-min">
            <div class="temp-mm-label">LOW</div>
            <div class="temp-mm-value"><span id="res-temp-min">‚Äî</span></div>
          </div>
          <div class="temp-mm temp-mm-max">
            <div class="temp-mm-label">HIGH</div>
            <div class="temp-mm-value"><span id="res-temp-max">‚Äî</span></div>
          </div>
        </div>
        <div class="tile-sub" id="res-temp-detail"></div>
      </div>

      <div class="resource-tile hidden" data-kind="net">
        <div class="tile-head">
          <div class="tile-label">üì° Network</div>
          <div class="tile-kpi" id="res-net">‚Äî</div>
        </div>
        <div class="net-row">
          <span class="net-badge rx">‚¨á Rx</span>
          <span class="net-value" id="res-net-rx">‚Äî</span>
          <span class="net-badge tx">‚¨Ü Tx</span>
          <span class="net-value" id="res-net-tx">‚Äî</span>
        </div>
        <div class="io-row" aria-hidden="true">
          <span class="io-badge rd">üíæ Read</span>
          <span class="io-value" id="res-io-rd">‚Äî</span>
          <span class="io-badge wr">‚úç Write</span>
          <span class="io-value" id="res-io-wr">‚Äî</span>
        </div>
        <div class="tile-sub" id="res-net-detail">Live throughput</div>
      </div>

      <div class="resource-tile hidden" data-kind="storage">
        <div class="tile-head">
          <div class="tile-label">üóÑ Storage</div>
          <div class="tile-kpi" id="res-storage">‚Äî</div>
        </div>
        <div class="storage-kpis">
          <div class="storage-primary" id="res-storage-detail">‚Äî</div>
          <div class="meter" aria-hidden="true"><div class="meter-fill" id="meter-storage"></div></div>
          <div class="storage-split" aria-hidden="true">
            <div class="storage-chip used">
              <div class="storage-chip-label">Used</div>
              <div class="storage-chip-value" id="res-storage-used">‚Äî</div>
            </div>
            <div class="storage-chip free">
              <div class="storage-chip-label">Free</div>
              <div class="storage-chip-value" id="res-storage-free">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- Full-width Uptime Section -->
  <section class="card uptime-section">
    <div class="row">
      <div>
        <strong>Uptime</strong>
        <div class="label" id="window">Last 30 days</div>
      </div>
      <select id="uptimeFilter" class="uptime-filter">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="180">Last 180 days</option>
        <option value="360">Last 360 days</option>
      </select>
    </div>
    
    <!-- Dynamic uptime bars will be rendered here -->
    <div id="uptime-bars-container"></div>
    
    <div class="uptime-footer">
      <span class="uptime-timestamp" id="timestamp-global">‚Äî</span>
    </div>
  </section>

  <!-- Discreet login modal -->
  <dialog id="loginModal">
    <form class="login">
      <div>
        <h3>Sign in</h3>
        <p class="muted">Enter your credentials</p>
      </div>
      <div>
        <label for="u">Username</label>
        <input id="u" type="text" autocomplete="username" placeholder="admin" required>
      </div>
      <div>
        <label for="p">Password</label>
        <input id="p" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      <div id="loginError" class="error hidden"></div>
      <div class="actions">
        <button id="doLogin" class="btn" type="button">Login</button>
        <button id="cancelLogin" class="ghost" type="button">Cancel</button>
      </div>
    </form>
  </dialog>

  {{if .IsAdmin}}
  <!-- Admin Panel with Tabs -->
  <section id="adminPanel" class="card admin-panel admin hidden">
    <div class="admin-tabs">
      <button class="tab-btn active" data-tab="main">Main</button>
      <button class="tab-btn" data-tab="services">Services</button>
      <button class="tab-btn" data-tab="banners">Banners</button>
      <button class="tab-btn" data-tab="security">Security</button>
      <button class="tab-btn" data-tab="resources">Resources</button>
      <button class="tab-btn" data-tab="alerts">Email</button>
    </div>

    <!-- Main Tab -->
    <div id="tab-main" class="tab-content active">
      <h2>Admin Controls</h2>
      <div class="admin-section">
        <h3>Service Management</h3>
        <p class="muted">Quick actions for all services</p>
        <div class="ops">
          <button id="ingestNowTab" class="btn">Check All Services Now</button>
          <button id="resetRecentTab" class="btn danger">Reset Recent Incidents</button>
        </div>
      </div>
    </div>

    <!-- Services Tab -->
    <div id="tab-services" class="tab-content">
      <div class="services-header">
        <h2>Manage Services</h2>
        <button id="addServiceBtn" class="btn">+ Add Service</button>
      </div>
      <p class="muted">Add, edit, or remove monitored services. Drag to reorder.</p>
      
      <div id="servicesList" class="services-list">
        <div class="muted">Loading services...</div>
      </div>
    </div>

    <!-- Banners Tab -->
    <div id="tab-banners" class="tab-content">
      <h2>Status Banners</h2>
      <p class="muted">Show alerts/banners to visitors about service issues or maintenance</p>
      
      <div class="admin-section">
        <h3>Create Banner</h3>
        <div class="form-group">
          <label for="bannerService">Scope</label>
          <select id="bannerService">
            <option value="">Global (top of page)</option>
            <option value="server">Server</option>
            <option value="plex">Plex</option>
            <option value="overseerr">Overseerr</option>
          </select>
        </div>
        <div class="form-group">
          <label for="bannerTemplate">Quick Templates</label>
          <select id="bannerTemplate">
            <option value="">-- Select a template --</option>
            <optgroup label="Maintenance">
              <option value="Scheduled maintenance in progress. Service may be temporarily unavailable.">Scheduled maintenance in progress</option>
              <option value="Maintenance complete. All services restored.">Maintenance complete</option>
              <option value="Scheduled maintenance tonight between 10 PM - 12 AM.">Scheduled maintenance tonight</option>
            </optgroup>
            <optgroup label="Issues">
              <option value="We are aware of issues and investigating.">Investigating issues</option>
              <option value="Experiencing degraded performance. Working on a fix.">Degraded performance</option>
              <option value="Service is currently down. We are working to restore it.">Service down</option>
              <option value="Intermittent connectivity issues. Please retry if needed.">Intermittent issues</option>
            </optgroup>
            <optgroup label="Updates">
              <option value="Issue has been resolved. Thank you for your patience.">Issue resolved</option>
              <option value="Update in progress. New features coming soon!">Update in progress</option>
              <option value="Service restored and operating normally.">Service restored</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label for="bannerMessage">Message</label>
          <input type="text" id="bannerMessage" placeholder="e.g., Scheduled maintenance tonight 10-11 PM" />
        </div>
        <div class="form-group">
          <label for="bannerLevel">Type</label>
          <select id="bannerLevel">
            <option value="info">Info (Blue)</option>
            <option value="warning">Warning (Yellow)</option>
            <option value="error">Error (Red)</option>
          </select>
        </div>
        <div class="ops">
          <button id="createBanner" class="btn">Create Banner</button>
        </div>
        
        <h3 style="margin-top: 20px;">Active Banners</h3>
        <div id="bannersList"></div>
      </div>
    </div>

    <!-- Security Tab -->
    <div id="tab-security" class="tab-content">
      <div class="blocks-header">
        <h2>IP Block Management</h2>
        <button id="resetBlocks" class="btn danger">Clear All Blocks</button>
      </div>
      <div id="blocksList" class="blocks-list">
        <div class="muted">Loading...</div>
      </div>
    </div>

    <!-- Resources Tab -->
    <div id="tab-resources" class="tab-content">
      <h2>Resources Monitoring</h2>
      <p class="muted">Monitor system resources using Glances. Requires <a href="https://nicolargo.github.io/glances/" target="_blank">Glances</a> running with web server enabled.</p>

      <div class="admin-section">
        <h3>Glances Connection</h3>
        <form id="resourcesForm">
          <div class="form-group">
            <label for="glancesUrl">Glances Host:Port</label>
            <input type="text" id="glancesUrl" placeholder="e.g., 192.168.1.100:61208 or server.local:61208">
            <small class="help-text">Enter the host and port where Glances web server is running. API path /api/4 is added automatically.</small>
          </div>
          
          <div class="form-group">
            <label for="resourcesEnabled">
              <input type="checkbox" id="resourcesEnabled"> Enable Resources section
            </label>
            <small class="help-text">Resources will only show when Glances is configured and reachable.</small>
          </div>

          <h3>Visible Tiles</h3>
          <div class="form-group tiles-group">
            <label>
              <input type="checkbox" id="resourcesCPU" checked> üñ•Ô∏è CPU
            </label>
            <label>
              <input type="checkbox" id="resourcesMemory" checked> üíæ RAM
            </label>
            <label>
              <input type="checkbox" id="resourcesNetwork" checked> üì° Network
            </label>
            <label>
              <input type="checkbox" id="resourcesTemp" checked> üå° Temperature
            </label>
            <label>
              <input type="checkbox" id="resourcesStorage" checked> üóÑ Storage
            </label>
          </div>

          <div class="ops">
            <button type="button" id="testGlances" class="btn ghost">Test Connection</button>
            <button type="button" id="saveResources" class="btn">Save Settings</button>
          </div>

          <div id="resourcesStatus" class="status-message hidden"></div>
        </form>
      </div>
    </div>

    <!-- Alerts Tab -->
    <div id="tab-alerts" class="tab-content">
      <h2>Email Alerts Configuration</h2>
      <p class="muted">Send email notifications when service status changes</p>
      
      <div class="admin-section">
        <h3>SMTP Settings</h3>
        <form id="alertsForm">
          <div class="form-group">
            <label for="alertsEnabled">
              <input type="checkbox" id="alertsEnabled"> Enable email alerts
            </label>
          </div>
          
          <div class="form-group">
            <label for="smtpHost">SMTP Host</label>
            <input type="text" id="smtpHost" placeholder="smtp.gmail.com" />
          </div>
          
          <div class="form-group">
            <label for="smtpPort">SMTP Port</label>
            <input type="number" id="smtpPort" placeholder="587" />
          </div>
          
          <div class="form-group">
            <label for="smtpUser">SMTP Username</label>
            <input type="text" id="smtpUser" placeholder="your-email@example.com" />
          </div>
          
          <div class="form-group">
            <label for="smtpPassword">SMTP Password</label>
            <input type="password" id="smtpPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          
          <div class="form-group">
            <label for="alertEmail">Alert Email (To)</label>
            <input type="email" id="alertEmail" placeholder="admin@example.com" />
          </div>
          
          <div class="form-group">
            <label for="alertFromEmail">From Email</label>
            <input type="email" id="alertFromEmail" placeholder="alerts@example.com" />
          </div>
          
          <div class="form-group">
            <h4>Alert Conditions</h4>
            <label>
              <input type="checkbox" id="alertOnDown" checked> Alert when service goes DOWN
            </label>
            <label>
              <input type="checkbox" id="alertOnDegraded" checked> Alert when service becomes DEGRADED
            </label>
            <label>
              <input type="checkbox" id="alertOnUp"> Alert when service comes back UP
            </label>
          </div>
          
          <div class="ops">
            <button type="button" id="saveAlerts" class="btn">Save Configuration</button>
            <button type="button" id="testEmail" class="btn ghost">Send Test Email</button>
          </div>
          
          <div id="alertStatus" class="status-message hidden"></div>
        </form>
      </div>
    </div>
  </section>
  {{end}}

  <!-- Service Add/Edit Modal -->
  <dialog id="serviceModal">
    <form class="service-form">
      <div class="modal-header">
        <h3 id="serviceModalTitle">Add Service</h3>
        <button type="button" class="close-btn" id="closeServiceModal">&times;</button>
      </div>
      
      <div class="form-group">
        <label for="serviceTemplate">Service Template</label>
        <select id="serviceTemplate">
          <option value="">-- Select a template (optional) --</option>
        </select>
        <small class="help-text" id="templateHelp"></small>
      </div>
      
      <div class="form-group">
        <label for="serviceName">Name *</label>
        <input type="text" id="serviceName" placeholder="e.g., My Plex Server" required>
      </div>
      
      <div class="form-group">
        <label for="serviceUrl">URL *</label>
        <input type="text" id="serviceUrl" placeholder="e.g., http://192.168.1.100:32400" required>
        <small class="help-text">For TCP checks, use: tcp://host:port</small>
      </div>
      
      <div class="form-group" id="tokenGroup">
        <label for="serviceToken">API Token</label>
        <input type="text" id="serviceToken" placeholder="Optional API token or key">
        <small class="help-text" id="tokenHelp">Some services require an API token for authentication</small>
      </div>
      
      <div class="form-group">
        <label for="serviceIconUrl">Custom Icon URL</label>
        <div class="icon-url-row">
          <input type="text" id="serviceIconUrl" placeholder="https://example.com/icon.svg">
          <div id="iconPreview" class="icon-preview hidden"></div>
        </div>
        <small class="help-text">Optional: Enter a URL to a custom icon image (SVG, PNG, etc.)</small>
      </div>
      
      <details class="advanced-settings">
        <summary>Advanced Settings</summary>
        
        <div class="form-group">
          <label for="serviceCheckType">Check Type</label>
          <select id="serviceCheckType">
            <option value="http">HTTP/HTTPS</option>
            <option value="tcp">TCP Port</option>
          </select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="serviceTimeout">Timeout (seconds)</label>
            <input type="number" id="serviceTimeout" value="5" min="1" max="60">
          </div>
          
          <div class="form-group">
            <label for="serviceInterval">Check Interval (seconds)</label>
            <input type="number" id="serviceInterval" value="60" min="10" max="3600">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="serviceExpectedMin">Expected Status Min</label>
            <input type="number" id="serviceExpectedMin" value="200" min="100" max="599">
          </div>
          
          <div class="form-group">
            <label for="serviceExpectedMax">Expected Status Max</label>
            <input type="number" id="serviceExpectedMax" value="399" min="100" max="599">
          </div>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="serviceVisible" checked>
            Show on public dashboard
          </label>
        </div>
      </details>
      
      <input type="hidden" id="serviceId">
      <input type="hidden" id="serviceType">
      
      <div id="testConnectionResult" class="test-result hidden"></div>
      
      <div class="modal-actions">
        <button type="button" id="testServiceConnection" class="btn ghost">Test Connection</button>
        <button type="button" id="saveService" class="btn">Save Service</button>
        <button type="button" id="cancelService" class="ghost">Cancel</button>
        <button type="button" id="deleteService" class="btn danger hidden">Delete</button>
      </div>
      
      <div id="serviceError" class="error hidden"></div>
    </form>
  </dialog>

  <footer>Auto-refreshing every 15s. Metrics need a few minutes to populate.</footer>
</body>
</html>