name: Pull Request Checks

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [ ${#PR_TITLE} -lt 10 ]; then
            echo "::error::PR title is too short. Please provide a descriptive title (at least 10 characters)."
            exit 1
          fi
          echo "✅ PR title is valid"

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "::error::This PR has merge conflicts. Please resolve them before merging."
            exit 1
          fi
          echo "✅ No merge conflicts detected"

      - name: Validate file changes
        run: |
          # Get list of changed files
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          
          # Check if any files were changed
          if [ ! -s changed_files.txt ]; then
            echo "::warning::No files were changed in this PR"
          else
            echo "Changed files:"
            cat changed_files.txt
            echo "✅ File changes validated"
          fi

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Run gosec security scan
        run: |
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest 2>/dev/null || \
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -no-fail -fmt text ./... 2>&1 | tee gosec-report.txt
          echo ""
          echo "### Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 gosec-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
